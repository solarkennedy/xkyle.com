<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
<meta http-equiv="x-ua-compatible" content="ie=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

<meta property="og:title" content="Managing Ssh Known Hosts With-Serf" />
<meta property="og:description" content="Serf is a very interesting service discovery mechanism. Its dynamic membership and tags capability make it very flexible. Can we use it to generate a centralized ssh_known_hosts file?
Installing and Configuring Serf I like to use configuration management to manage servers. Here I use a Puppet module to install and configure Serf:
class { &#39;serf&#39;: config_hash =&gt; { &#39;node_name&#39; =&gt; $::fqdn, &#39;tags&#39; =&gt; { &#39;sshrsakey&#39; =&gt; $::sshrsakey }, &#39;discover&#39; =&gt; &#39;cluster&#39;, } }  This particular module uses a hash to translate directly into the config." />
<meta property="og:type" content="article" />
<meta property="og:url" content="/Managing-Ssh-Known-Hosts-With-Serf/" /><meta property="article:published_time" content="2014-04-06T05:33:58&#43;00:00"/>
<meta property="article:modified_time" content="2014-04-06T05:33:58&#43;00:00"/>

<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Managing Ssh Known Hosts With-Serf"/>
<meta name="twitter:description" content="Serf is a very interesting service discovery mechanism. Its dynamic membership and tags capability make it very flexible. Can we use it to generate a centralized ssh_known_hosts file?
Installing and Configuring Serf I like to use configuration management to manage servers. Here I use a Puppet module to install and configure Serf:
class { &#39;serf&#39;: config_hash =&gt; { &#39;node_name&#39; =&gt; $::fqdn, &#39;tags&#39; =&gt; { &#39;sshrsakey&#39; =&gt; $::sshrsakey }, &#39;discover&#39; =&gt; &#39;cluster&#39;, } }  This particular module uses a hash to translate directly into the config."/>


    <meta name="description" content="">
    <link rel="canonical" href="../Managing-Ssh-Known-Hosts-With-Serf/">

    
    <title>Managing Ssh Known Hosts With-Serf &middot; xkyle.com</title>

    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/css/materialize.min.css">
    <link href="css/style.css" rel="stylesheet">

    

    

    
  </head>
  <body>
    
      



<nav class="white" role="navigation">
    <div class="row max-width">
        <div class="col s12 l10 offset-l1">
            
            <a href="#" data-target="nav-mobile" class="sidenav-trigger black-text">
                <i class="material-icons">menu</i>
            </a>

            
            <ul id="nav-mobile" class="sidenav">
                
                
    
    

            </ul>

            
            <a href="../" class="brand-logo grey-text text-darken-3">xkyle.com</a>

            
            <div class="nav-wrapper">

                
                <ul class="right hide-on-med-and-down">
                    
                    
    
    

                </ul>

            </div>
        </div>
    </div>
</nav>
    

    

<article class="max-width">
    
    <section class="row">
        <div class="col s12 m10 offset-m1 l10 offset-l1">
            <h1>Managing Ssh Known Hosts With-Serf</h1>
        </div>
    </section>

    
    

    
    <section class="row">
        <div class="col s12 m8 offset-m2 l2 offset-l1">
            

<p class="article-meta">
    <div class="article-meta-container">
        <div class="article-meta-author-name"></div>
        <div class="article-meta-description"></div>
    </div>
    <span class="article-meta-published-at grey-text text-darken-1">Apr 6, 2014</span>
</p>
        </div>
        <div class="col s12 m8 offset-m2 l6">
            

<p><a href="http://www.serfdom.io/">Serf</a> is a very interesting service discovery mechanism.
Its dynamic membership and tags capability make it very flexible. Can we use it
to generate a centralized <code>ssh_known_hosts</code> file?</p>

<h2 id="installing-and-configuring-serf">Installing and Configuring Serf</h2>

<p>I like to use configuration management to manage servers. Here I use a
<a href="https://github.com/justinclayton/puppet-module-serf">Puppet module</a> to
install and configure Serf:</p>

<pre><code class="language-ruby">class { 'serf':
  config_hash   =&gt; {  
    'node_name'  =&gt; $::fqdn, 
    'tags'       =&gt; {
      'sshrsakey' =&gt; $::sshrsakey
    },          
    'discover'   =&gt; 'cluster',
  }     
}
</code></pre>

<p>This particular module uses a hash to translate directly into the <code>config.json</code>
file on disk. Notice how I&rsquo;m using the new <code>tags</code> feature, and adding a <code>sshrsakey</code>
tag, populated by Puppet&rsquo;s facts.</p>

<h2 id="querying-the-cluster">Querying The Cluster</h2>

<p>Once the servers have Serf installed and configured, the cluster can be queried
using the serf command line tool:</p>

<pre><code>$ serf members
server1.xkyle.com    192.168.1.67:7946    alive    sshrsakey=AAAA...
server2.xkyle.com    192.168.1.69:7946    alive    sshrsakey=AAAA...
</code></pre>

<h2 id="using-the-data">Using the Data</h2>

<p>Lets use this data to write out our <code>/etc/ssh/ssh\_known\_hosts</code> file,
emulating the the functionality of ssh-keyscan:</p>

<pre><code class="language-bash">$ serf members -format=json | jq -r '.members | .[] | &quot;\(.name) ssh-rsa \(.tags[])&quot; ' | tee /etc/ssh/ssh_known_hosts
server1.xkyle.com ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABAQDTfPpmHhc+LoD05puxC...
server2.xkyle.com ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABAQCmzk+Chzrq73c5ytU9I...
</code></pre>

<p>So&hellip; you can see I&rsquo;m using <a href="http://stedolan.github.io/jq/manual/">jq</a> to
manipulate the JSON ouput of the serf command. I&rsquo;m not super proud of it,
but it works.</p>

<p>Lets see if we can use a script instead? Serf provides and
<a href="http://www.serfdom.io/docs/agent/rpc.html">RPC protocol</a> to interact with
it programmatically:</p>

<pre><code class="language-ruby">#!/usr/bin/env ruby
require 'serf/client'
client = Serf::Client.connect address: '127.0.0.1', port: 7373
members = client.members.value.body['Members']
puts members.collect { |x| x['Name'] + ' ssh-rsa ' +  x['Tags']['sshrsakey'] }
</code></pre>

<p>Of course, no error handling or anything. This script achieves the same
result using the <a href="https://rubygems.org/gems/serf-client">serf-client ruby gem</a>.</p>

<p>There are libraries to connect to the Serf RPC directly for many languages,
or you can do it yourself using the <a href="http://msgpack.org/rpc/rdoc/current/MessagePack/RPC.html">msgpack RPC library</a>
to communicate directly on the tcp socket.</p>

<h2 id="conclusion">Conclusion</h2>

<p>This is just the beginning. Serf allows retrieving the status of members, but
also can spawn programs (handlers) whenever members
<a href="http://www.serfdom.io/docs/agent/event-handlers.html">join or leave</a>.</p>

<p>Additionally you can invoke <a href="http://www.serfdom.io/docs/commands/event.html">custom events</a>
for your own uses, like code deploys.</p>

<p>If you can deal with an <a href="https://en.wikipedia.org/wiki/CAP_theorem">AP</a> discovery
and orchistration system, then Serf could be a foundation for building great things!</p>

        </div>
    </section>
</article>



    
      <footer class="page-footer grey lighten-5">
    <div class="row max-width">
        <div class="col s12 l10 offset-l1 clear-padding">
            <div class="row">
    
        
    

    
    
    <div class="col s12 l12">
        <h5 class="black-text"></h5>
<p class="grey-text text-darken-4"></p>

    </div>

    
</div>


        </div>
    </div>
    <div class="footer-copyright">
        <div class="row max-width" style="width: 100%;">
            <div class="col s12 l10 offset-l1">
                <span class="grey-text text-darken-4"></span>
<div class="right">
    
</div>
            </div>
        </div>
    </div>
</footer>
    

    
    <script src="https://code.jquery.com/jquery-3.2.1.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/js/materialize.min.js"></script>
    <script src="js/script.js"></script>
  </body>
</html>
