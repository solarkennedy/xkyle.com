<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
<meta http-equiv="x-ua-compatible" content="ie=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

<meta property="og:title" content="What Happens When You Run Puppet Tests" />
<meta property="og:description" content="Breaking down bundle exec rake spec What is happening when you run:
bundle exec rake spec  Bundle The first command you are running is bundle. Bundle is kinda like virtualenv for Ruby. It makes sure that you use the same ruby libraries that you, everyone, and puppetmasters use.
Bundle uses a Gemfile, and searches downwards. As long as you have the Gemfile in the puppet repo, it will work." />
<meta property="og:type" content="article" />
<meta property="og:url" content="/What-Happens-When-You-Run-Puppet-Tests/" /><meta property="article:published_time" content="2014-03-31T05:33:58&#43;00:00"/>
<meta property="article:modified_time" content="2014-03-31T05:33:58&#43;00:00"/>

<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="What Happens When You Run Puppet Tests"/>
<meta name="twitter:description" content="Breaking down bundle exec rake spec What is happening when you run:
bundle exec rake spec  Bundle The first command you are running is bundle. Bundle is kinda like virtualenv for Ruby. It makes sure that you use the same ruby libraries that you, everyone, and puppetmasters use.
Bundle uses a Gemfile, and searches downwards. As long as you have the Gemfile in the puppet repo, it will work."/>


    <meta name="description" content="">
    <link rel="canonical" href="../What-Happens-When-You-Run-Puppet-Tests/">

    
    <title>What Happens When You Run Puppet Tests &middot; xkyle.com</title>

    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/css/materialize.min.css">
    <link href="css/style.css" rel="stylesheet">

    

    

    
  </head>
  <body>
    
      



<nav class="white" role="navigation">
    <div class="row max-width">
        <div class="col s12 l10 offset-l1">
            
            <a href="#" data-target="nav-mobile" class="sidenav-trigger black-text">
                <i class="material-icons">menu</i>
            </a>

            
            <ul id="nav-mobile" class="sidenav">
                
                
    
    

            </ul>

            
            <a href="../" class="brand-logo grey-text text-darken-3">xkyle.com</a>

            
            <div class="nav-wrapper">

                
                <ul class="right hide-on-med-and-down">
                    
                    
    
    

                </ul>

            </div>
        </div>
    </div>
</nav>
    

    

<article class="max-width">
    
    <section class="row">
        <div class="col s12 m10 offset-m1 l10 offset-l1">
            <h1>What Happens When You Run Puppet Tests</h1>
        </div>
    </section>

    
    

    
    <section class="row">
        <div class="col s12 m8 offset-m2 l2 offset-l1">
            

<p class="article-meta">
    <div class="article-meta-container">
        <div class="article-meta-author-name"></div>
        <div class="article-meta-description"></div>
    </div>
    <span class="article-meta-published-at grey-text text-darken-1">Mar 31, 2014</span>
</p>
        </div>
        <div class="col s12 m8 offset-m2 l6">
            

<h2 id="breaking-down-bundle-exec-rake-spec">Breaking down bundle exec rake spec</h2>

<p>What is happening when you run:</p>

<pre><code class="language-bash">bundle exec rake spec
</code></pre>

<h4 id="bundle">Bundle</h4>

<p>The first command you are running is <a href="http://bundler.io/">bundle</a>. Bundle is
kinda like virtualenv for Ruby. It makes sure that you use the same ruby
libraries that you, everyone, and puppetmasters use.</p>

<p>Bundle uses a Gemfile, and searches downwards. As long as you have the Gemfile
in the puppet repo, it will work.</p>

<h4 id="exec">Exec</h4>

<p>The second part is exec. Exec is an argument to bundle, it simply means run a
command. Because you are running it in a “bundled” environment, it runs the
next command that is part of your bundle, with the ruby libraries in your
Gemfile.</p>

<h4 id="rake">Rake</h4>

<p>The third part is rake.  Rake is like Make for Ruby. It requires a Rakefile.
Each puppet module needs a Rakefile.</p>

<p>You don’t need to re-invent the Rakefile, simply have this in it:</p>

<pre><code class="language-ruby">require 'puppetlabs_spec_helper/rake_tasks'
</code></pre>

<p>This ensures that we are all running tests in the same way.</p>

<h4 id="spec">Spec</h4>

<p>Spec is a “rake task” that runs Rspec. Rspec is a ruby testing framework.
Rspec + puppet-rspec is a whole other thing described Next Section.</p>

<h2 id="how-does-rspec-test-puppet-code">How does Rspec Test Puppet Code?</h2>

<p>If you are running bundle exec rake spec, rspec takes over in the environment
 provided by bundler. It gives you all the gems necissary to do the job, but
how does Rspec know about Puppet Code?</p>

<p>If you are including the puppetlabs_spec_helper/rake_tasks, your
<a href="https://github.com/puppetlabs/puppetlabs_spec_helper/blob/master/lib/puppetlabs_spec_helper/rake_tasks.rb#L106">exact task</a>
includes the prep/test/clean stuff.</p>

<p>You need some boilerplate files in place for rspec-puppet tests to run. You can
either run</p>

<pre><code class="language-bash">rspec-puppet-init
</code></pre>

<p>Or you can <a href="http://rspec-puppet.com/setup/">manually setup</a> the files and folders.
Here I will describe the minimal set of files you need:</p>

<h3 id="fixtures-yml">.fixtures.yml</h3>

<p>.fixtures.yml is a puppet_spec_helper construct that allows you to symlink in
other modules that might be required to test your code. For example you might
require functions from the stdlib. How does Rspec know where stdlib is?</p>

<pre><code class="language-yaml">fixtures:
  repositories:
    stdlib: &quot;git://github.com/puppetlabs/puppetlabs-stdlib.git&quot;
  symlinks:
    your_module: &quot;#{source_dir}&quot;
</code></pre>

<p>When rspec runs the preparation parts, the spec_helper will create symlinks,
or <a href="https://github.com/puppetlabs/puppetlabs_spec_helper#fixtures-examples">clone repos, or whatever.</a></p>

<h3 id="spec-spec-helper-rb">spec/spec_helper.rb</h3>

<p>spec/spec_helper.rb is a file you need in place for your rspec tests to reference.
If you are using the puppetlabs_spec_helper gem, it is only one line:</p>

<pre><code class="language-ruby">require 'puppetlabs_spec_helper/module_spec_helper'
</code></pre>

<p>This spec_helper.rb file can now be referenced, and by doing so will
allow Ruby to import all of the puppet-specific Rspec matchers it needs to
function.</p>

<p>For example, at the top of every Rspec ruby file you should see something like this:</p>

<pre><code class="language-ruby">require 'spec_helper'

describe 'my_module' do

  it { should compile }

end
</code></pre>

<h3 id="directory-structure">Directory structure</h3>

<p>Putting files in the right places allows Rspec to autodetect them. Giving them a
conventional name allows rspec to glob them.</p>

<p>As the scope of your testing increases, a well-organized directory structure is
essential:</p>

<pre><code>├── spec
│   ├── classes
│   │   └── example_spec.rb
│   ├── defines
│   ├── functions
│   ├── hosts
│   ├── spec_helper.rb
│   ├── spec_helper_system.rb
│   └── system
│       └── basic_spec.rb
</code></pre>

<h3 id="the-tests">The Tests</h3>

<p>How to write puppet tests is outside the scope of this particular blog post.</p>

<p>I recommend looking at solid examples from puppetlabs&rsquo; github, or right from the
<a href="http://rspec-puppet.com/tutorial/">offical documentation</a>.</p>

<p>But essentially, Rspec runs puppet in a noop mode, only generating a catelog
of what it would do. Then the rspec tests use <a href="http://rspec-puppet.com/matchers/">matchers</a>
to describe assertions against the catelog.</p>

        </div>
    </section>
</article>



    
      <footer class="page-footer grey lighten-5">
    <div class="row max-width">
        <div class="col s12 l10 offset-l1 clear-padding">
            <div class="row">
    
        
    

    
    
    <div class="col s12 l12">
        <h5 class="black-text"></h5>
<p class="grey-text text-darken-4"></p>

    </div>

    
</div>


        </div>
    </div>
    <div class="footer-copyright">
        <div class="row max-width" style="width: 100%;">
            <div class="col s12 l10 offset-l1">
                <span class="grey-text text-darken-4"></span>
<div class="right">
    
</div>
            </div>
        </div>
    </div>
</footer>
    

    
    <script src="https://code.jquery.com/jquery-3.2.1.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/js/materialize.min.js"></script>
    <script src="js/script.js"></script>
  </body>
</html>
