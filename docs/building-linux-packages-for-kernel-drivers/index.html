<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
<meta http-equiv="x-ua-compatible" content="ie=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

<meta property="og:title" content="Building Linux Packages For Kernel Drivers! (dkms howto)" />
<meta property="og:description" content="Background Most of the time the Linux kernel does a great job of having drivers you need, but sometimes you need to install a special driver or update an existing module.
Running make; make install is all fine and dandy for testing, but for production you want a repeatable process. For me, this means OS packages. (deb/rpms)

So, how do you go from kernel module source code =&gt; Debian package?" />
<meta property="og:type" content="article" />
<meta property="og:url" content="/building-linux-packages-for-kernel-drivers/" /><meta property="article:published_time" content="2013-01-20T03:39:48&#43;00:00"/>
<meta property="article:modified_time" content="2013-01-20T03:39:48&#43;00:00"/>
<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Building Linux Packages For Kernel Drivers! (dkms howto)"/>
<meta name="twitter:description" content="Background Most of the time the Linux kernel does a great job of having drivers you need, but sometimes you need to install a special driver or update an existing module.
Running make; make install is all fine and dandy for testing, but for production you want a repeatable process. For me, this means OS packages. (deb/rpms)

So, how do you go from kernel module source code =&gt; Debian package?"/>


    <meta name="description" content="">
    <link rel="canonical" href="../building-linux-packages-for-kernel-drivers/">

    
    <title>Building Linux Packages For Kernel Drivers! (dkms howto) &middot; xkyle.com</title>

    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/materialize/0.100.2/css/materialize.min.css">

    <link href="css/style.css" rel="stylesheet">

    

    

    
  </head>
  <body>
    
      



<nav class="white" role="navigation">
    <div class="row max-width">
        <div class="col s12 l10 offset-l1">
            
            <a href="#" data-activates="nav-mobile" class="button-collapse black-text">
                <i class="material-icons">menu</i>
            </a>

            
            <ul id="nav-mobile" class="side-nav">
                
                
    
    

            </ul>

            
            <a href="../" class="brand-logo grey-text text-darken-3">xkyle.com</a>

            
            <div class="nav-wrapper">

                
                <ul class="right hide-on-med-and-down">
                    
                    
    
    

                </ul>

            </div>
        </div>
    </div>
</nav>
    

    

<article class="max-width">
    
    <section class="row">
        <div class="col s12 m10 offset-m1 l10 offset-l1">
            <h1>Building Linux Packages For Kernel Drivers! (dkms howto)</h1>
        </div>
    </section>

    
    

    
    <section class="row">
        <div class="col s12 m8 offset-m2 l2 offset-l1">
            

<p class="article-meta">
    <div class="article-meta-container">
        <div class="article-meta-author-name">admin</div>
        <div class="article-meta-description"></div>
    </div>
    <span class="article-meta-published-at grey-text text-darken-1">Jan 20, 2013</span>
</p>
        </div>
        <div class="col s12 m8 offset-m2 l6">
            

<h2 id="background">Background</h2>

<p>Most of the time the Linux kernel does a great job of having drivers you need, but sometimes you need to install a special driver or update an existing module.</p>

<p>Running make; make install is all fine and dandy for testing, but for production you want a repeatable process. For me, this means OS packages. (deb/rpms)</p>

<p><a href="../uploads/morpheus-ipmi.jpg"><img src="../uploads/33657094-300x181.jpg" alt="33657094" /></a></p>

<p>So, how do you go from kernel module source code =&gt; Debian package? DKMS. DKMS will automatically build your kernel module for you, even if your kernel gets updated.</p>

<h2 id="example-ixgbe">Example: ixgbe</h2>

<p>Lets build something. In this example I&rsquo;m on an Ubuntu machine building the latest ixgbe driver.</p>

<ol>
<li>Get apt-get your stuff</li>
</ol>

<pre><code class="language-bash">        apt-get install debhelper dkms kernel-headers
</code></pre>

<ol>
<li>Untar your source code into /usr/src/$modulename-$version, like /usr/src/ixgbe-3.12.6/</li>
<li>Normally here you would run &ldquo;make&rdquo;, but instead we will make a dkms.conf file to describe how to build it. Like this:
<br /></li>
</ol>

<pre><code class="language-bash">        MAKE=&quot;make -C src/ KERNELDIR=/lib/modules/${kernelver}/build&quot;
        CLEAN=&quot;make -C src/ clean&quot;
        BUILT_MODULE_NAME=ixgbe
        BUILT_MODULE_LOCATION=src/
        DEST_MODULE_LOCATION=&quot;/updates&quot;
        PACKAGE_NAME=ixgbe-dkms
        PACKAGE_VERSION=3.12.6
        REMAKE_INITRD=no
</code></pre>

<ol>
<li>Next we need to register that module with dkms:</li>
</ol>

<pre><code class="language-bash">        root@server:/usr/src/ixgbe-3.12.6# dkms add -m ixgbe -v 3.12.6
        Creating symlink /var/lib/dkms/ixgbe/3.12.6/source -&gt;
         /usr/src/ixgbe-3.12.6
        DKMS: add completed.
</code></pre>

<ol>
<li>Next we will build the module, but using the dkms build command instead of make:</li>
</ol>

<pre><code class="language-bash">        root@server:/usr/src/ixgbe-3.12.6# dkms build -m ixgbe -v 3.12.6
        Kernel preparation unnecessary for this kernel. Skipping...
        Building module:
        cleaning build area....
        make KERNELRELEASE=3.2.0-23-generic -C src/ KERNELDIR=/lib/modules/3.2.0-23-generic/build....................
        cleaning build area....
        DKMS: build completed.
</code></pre>

<ol>
<li>Great! Next we will make a debian src package.
<br /></li>
</ol>

<pre><code class="language-bash">        root@server:/usr/src/ixgbe-3.12.6# dkms mkdsc -m ixgbe -v 3.12.6 --source-only
        Using /etc/dkms/template-dkms-mkdsc
        copying template...
        modifying debian/changelog...
        modifying debian/compat...
        modifying debian/control...
        modifying debian/copyright...
        modifying debian/dirs...
        modifying debian/postinst...
        modifying debian/prerm...
        modifying debian/README.Debian...
        modifying debian/rules...
        copying legacy postinstall template...
        Copying source tree...
        Building source package... dpkg-source --before-build ixgbe-dkms-3.12.6
         debian/rules clean
         dpkg-source -b ixgbe-dkms-3.12.6
        dpkg-source: warning: no source format specified in debian/source/format, see dpkg-source(1)
         dpkg-genchanges -S &gt;../ixgbe-dkms_3.12.6_source.changes
        dpkg-genchanges: including full source code in upload
         dpkg-source --after-build ixgbe-dkms-3.12.6
        DKMS: mkdsc completed.
        Moving built files to /var/lib/dkms/ixgbe/3.12.6/dsc...
        Cleaning up temporary files...
</code></pre>

<ol>
<li>Now we will build the &ldquo;binary&rdquo; debian package. In reality with &ndash;source-only this binary package just contains the source code in the module with a post install script to build the module for each kernel you are using. Its magic:</li>
</ol>

<pre><code class="language-bash">        root@server:/usr/src/ixgbe-3.12.6# dkms mkdeb -m ixgbe -v 3.12.6 --source-only
        Using /etc/dkms/template-dkms-mkdeb
        copying template...
        modifying debian/changelog...
        modifying debian/compat...
        modifying debian/control...
        modifying debian/copyright...
        modifying debian/dirs...
        modifying debian/postinst...
        modifying debian/prerm...
        modifying debian/README.Debian...
        modifying debian/rules...
        copying legacy postinstall template...
        Copying source tree...
        Building binary package...dpkg-buildpackage: warning: using a gain-root-command while being root
         dpkg-source --before-build ixgbe-dkms-3.12.6
         fakeroot debian/rules clean
         debian/rules build
         fakeroot debian/rules binary
         dpkg-genchanges -b &gt;../ixgbe-dkms_3.12.6_amd64.changes
        dpkg-genchanges: binary-only upload - not including any source code
         dpkg-source --after-build ixgbe-dkms-3.12.6
        DKMS: mkdeb completed.
        Moving built files to /var/lib/dkms/ixgbe/3.12.6/deb...
        Cleaning up temporary files...
</code></pre>

<ol>
<li>We have a deb! Lets put it in ~</li>
</ol>

<pre><code class="language-bash">        root@server:/usr/src/ixgbe-3.12.6# cp /var/lib/dkms/ixgbe/3.12.6/deb/ixgbe-dkms_3.12.6_all.deb ~
</code></pre>

<ol>
<li>So we have a deb. I would like to install it, but we have to get rid of the build files so they will not conflict with the deb we just built:</li>
</ol>

<pre><code class="language-bash">        root@server:/usr/src/ixgbe-3.12.6# rm -r /var/lib/dkms/ixgbe/
</code></pre>

<ol>
<li>Now we have a deb that you can install locally, distribute wherever, install across a cluster:</li>
</ol>

<pre><code class="language-bash">        root@server:/usr/src/ixgbe-3.12.6# dpkg -i /root/ixgbe-dkms_3.12.6_all.deb
        Selecting previously unselected package ixgbe-dkms.
        (Reading database ... 56500 files and directories currently installed.)
        Unpacking ixgbe-dkms (from .../root/ixgbe-dkms_3.12.6_all.deb) ...
        Setting up ixgbe-dkms (3.12.6) ...
        Loading new ixgbe-3.12.6 DKMS files...
        First Installation: checking all kernels...
        Building only for 3.2.0-23-generic
        Building for architecture x86_64
        Building initial module for 3.2.0-23-generic
        Done.
        ixgbe:
        Running module version sanity check.
        - Original module
        - Installation
        - Installing to /lib/modules/3.2.0-23-generic/updates/dkms/
        depmod....
        DKMS: install completed.
</code></pre>

<h2 id="33657298-uploads-33657298-jpg-uploads-33657298-jpg"><a href="../uploads/33657298.jpg"><img src="../uploads/33657298.jpg" alt="33657298" /></a></h2>

<h2 id="reading-more">Reading More:</h2>

<ul>
<li><a href="https://wiki.xkyle.com/DKMS_Howto">https://wiki.xkyle.com/DKMS_Howto</a></li>
<li><a href="http://en.wikipedia.org/wiki/Dynamic_Kernel_Module_Support">http://en.wikipedia.org/wiki/Dynamic_Kernel_Module_Support</a></li>
</ul>

        </div>
    </section>
</article>



    
      <footer class="page-footer grey lighten-5">
    <div class="row max-width">
        <div class="col s12 l10 offset-l1 clear-padding">
            <div class="row">
    
        
    

    
    
    <div class="col s12 l12">
        <h5 class="black-text"></h5>
<p class="grey-text text-darken-4"></p>

    </div>

    
</div>


        </div>
    </div>
    <div class="footer-copyright">
        <div class="row max-width" style="width: 100%;">
            <div class="col s12 l10 offset-l1">
                <span class="grey-text text-darken-4"></span>
<div class="right">
    
</div>
            </div>
        </div>
    </div>
</footer>
    

    
    <script src="https://code.jquery.com/jquery-3.2.1.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/materialize/0.100.2/js/materialize.min.js"></script>
    <script src="js/script.js"></script>
  </body>
</html>